## LDAP 인젝션 (LDAP Injection)

LDAP 인젝션은 애플리케이션이 사용자 입력을 LDAP 쿼리(검색 필터 또는 DN)에 직접 삽입할 때 발생하는 취약점입니다.
공격자는 조작된 입력으로 LDAP 필터 구조를 바꿔 권한 우회, 정보 노출, 인증 우회 등을 시도할 수 있습니다.

```
String username = request.getParameter("user");
String filter = "(&(objectClass=person)(uid=" + username + "))";
NamingEnumeration<SearchResult> results = ctx.search("ou=users,dc=example,dc=com", filter, controls);
```
* 사용자 입력을 필터에 바로 삽입하는 취약한 코드

## 🩻 취약한 시나리오

웹 앱이 URL 파라미터를 받아서 LDAP 검색 필터를 **문자열 연결**으로 만든다면 인젝션이 가능해집니다.

예: 사용자가 `uid`를 쿼리 파라미터로 넘기면 서버가 다음처럼 필터를 만든다고 가정합니다.

```
https://example.com/search?uid=john
```

서버 코드(취약한 형태, 예시):

```java
// (취약) 사용자 입력을 바로 필터에 연결
String uid = request.getParameter("uid");
String filter = "(&(objectClass=person)(uid=" + uid + "))";
ctx.search("ou=users,dc=example,dc=com", filter, controls);
```

이 경우 `uid` 값에 특수문자/연산자를 넣으면 원래 의도와 다른 필터가 만들어집니다.

---

## 공격자 문구/탐지용 페이로드

* `*`  → 와일드카드 테스트
* `)` 또는 `)(&` → 구문 에러 유발(파서 반응 관찰)
* `*)(|(uid=*))` → AND 필터를 깨고 OR로 확장해 결과 늘리기 (위험하니 테스트 환경에서만)


1. **와일드카드 테스트** — 폭넓은 매치 확인

   * URL: `https://example.com/search?uid=*`
   * 기대 (안전한 동작): 애플리케이션이 와일드카드를 허용하지 않으면 특수문자를 이스케이프하거나 에러/빈 결과를 반환.
   * 취약 시: 많은(또는 모든) 사용자 엔트리가 반환된다 → 필터에 `*`가 그대로 들어가서 매칭이 확장된 것.

2. **괄호로 구조 파괴(에러 확인)** — 필터 구문 에러 관찰

   * URL: `https://example.com/search?uid=)(&`  (또는 `uid=)` 등)
   * 기대: 서버 또는 LDAP이 구문 오류를 반환(에러 응답/로그에 LDAP parse error 등) → 입력이 필터 구문에 직접 반영되는 신호.
   * 취약 시: LDAP 파서 오류/500 에러/또는 예상과 다른 응답이 나타남.

3. **논리 연산자 포함(확장된 매칭 확인)** — (더 공격적이므로 테스트 환경에서만)

   * URL 예: `https://example.com/search?uid=*)(|(uid=*))`
   * 결과: 원래 필터이 `(&(objectClass=person)(uid=...))` 가 변조되어 `(&(...)(uid=*)(|(uid=*)))` 등으로 바뀌며 많은 항목이 반환될 수 있다.
   * **주의**: 이 패턴은 실제 인증 우회나 데이터 노출로 이어질 수 있으므로 오직 허가된 테스트 환경에서만 사용하세요.

> 요약: 먼저 `*` 과 괄호/특수문자를 넣어서 **결과 범위 확장(많은 결과)**이나 **구문 에러**가 발생하는지 확인하면 인젝션 가능성을 파악할 수 있습니다.

---

## 3) 서버/로그에서 확인하는 방법 (비파괴적)

* **응답 내용 비교**: 정상 값 vs 특수문자 값에 대한 응답(결과 수, 에러 메시지) 차이 관찰.
* **애플리케이션 로그 / LDAP 서버 로그**: LDAP 쿼리 필터가 어떻게 구성되는지(로그에 남아 있다면) 확인.
* **테스트 계정 사용**: 민감 데이터가 아닌 더미 계정들로만 테스트.
* **타임아웃/에러 패턴**: 특수문자 입력 시 LDAP 파서 에러나 예외 발생 여부 확인.


